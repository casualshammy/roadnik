name: Build and Publish

on:
  push:
    branches:
      - 'dev/**'

jobs:
  build:

    runs-on: windows-latest
    permissions: write-all
      
    steps:
    - name: Get dotnet
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'
      
    - name: Install Python3   
      uses: actions/setup-python@v2
      with:
        python-version: '3.11' # Version range or exact version of a Python version to use, using SemVer's version range syntax
        architecture: 'x64' # optional x64 or x86. Defaults to x64 if not specified
      
    - name: Install Node
      uses: actions/setup-node@v3
      with:
        node-version: '>=18.16.0'
      
    - uses: actions/checkout@v2
      with:
        submodules: true
        fetch-depth: 0

    - name: GitHub Integration
      run: python build_common/github_integration.py

    - name: "üè∑Ô∏è Push tag"
      uses: EndBug/latest-tag@latest
      with:
        tag-name: "${{ env.tag }}"

    # - name: Push tag
    #   uses: laputansoft/github-tag-action@v4.6
    #   with:
    #     github_token: ${{ secrets.GITHUB_TOKEN }}
    #     tag: ${{ env.tag }}

    - name: Build Server Windows x64
      run: python build-server.py --platform win-x64

    # - name: Build Server Ubuntu 18.04 x64
    #   run: python build-server.py --platform ubuntu.18.04-x64

    # - name: Build Client Android
    #   run: python build-client.py --framework net6.0-android
    #   env:
    #     ANDROID_SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }} 
        
    # - name: Create Github Release
    #   uses: "marvinpinto/action-automatic-releases@latest"
    #   with:
    #     repo_token: "${{ secrets.GITHUB_TOKEN }}"
    #     prerelease: false
    #     automatic_release_tag: "latest-release"
    #     title: "Release ${{ env.tag }}"
    #     files: |
    #       *.zip
    #       *.apk

    - name: Create Github Release
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        prerelease: false
        files: |
          *.zip
          *.apk
        name: "Release ${{ env.tag }}"
        tag_name: "${{ env.tag }}"
        fail_on_unmatched_files: false
        token: ${{ secrets.GITHUB_TOKEN }}
        generate_release_notes: false
